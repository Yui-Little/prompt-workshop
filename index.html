<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AI æç¤ºè¯å·¥åŠ Â· å“åº”å¼</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    referrerpolicy="no-referrer"
  />
  <style>
    :root{
      --bg:#fff;
      --line:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --black:#111111;
    }
    html,body{background:var(--bg);color:var(--text);}
    body{
      background:
        radial-gradient(circle at 10% 8%, rgba(0,0,0,.035), transparent 30%),
        radial-gradient(circle at 92% 0%, rgba(0,0,0,.025), transparent 38%),
        #fff;
      -webkit-tap-highlight-color: transparent;
    }
    .card{background:rgba(255,255,255,.92);backdrop-filter:blur(8px);}
    .soft{box-shadow:0 8px 30px rgba(17,24,39,.06);}
    .fade-up{opacity:0;transform:translateY(14px);transition:.6s ease;}
    .fade-up.in{opacity:1;transform:translateY(0);}
    .btn-press{transition:.15s transform ease;}
    .btn-press:active{transform:scale(.98);}
    .spinner{
      width:14px;height:14px;border-radius:999px;border:2px solid rgba(255,255,255,.35);
      border-top-color:#fff;animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .modal-mask{
      position:fixed;inset:0;background:rgba(17,24,39,.45);
      opacity:0;pointer-events:none;transition:.25s ease;
      backdrop-filter: blur(2px);
      z-index:60;
    }
    .modal-mask.show{opacity:1;pointer-events:auto;}
    .modal-panel{
      position:fixed;left:0;right:0;bottom:0;z-index:70;
      transform:translateY(100%);transition:.28s ease;
      border-top-left-radius:18px;border-top-right-radius:18px;
      max-height:85dvh;overflow:auto;
    }
    .modal-panel.show{transform:translateY(0);}
    .safe-bottom{padding-bottom:calc(env(safe-area-inset-bottom) + 12px);}

    /* æ¡Œé¢å“åº”å¼å¸ƒå±€ - æ ¸å¿ƒä¿®æ”¹ */
    @media (min-width: 1024px) {
      .desktop-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        max-width: 1400px;
        margin: 0 auto;
      }
      .desktop-full {
        grid-column: span 2;
      }
      .desktop-tip {
        display: none; /* éšè—æç¤ºï¼Œå› ä¸ºæ¡Œé¢ä½“éªŒå·²ç»ä¼˜åŒ– */
      }
      .modal-panel {
        max-width: 480px;
        left: auto;
        right: 2rem;
        bottom: 2rem;
        border-radius: 24px;
        transform: translateY(0) scale(0.95);
        opacity: 0;
        transition: 0.2s ease;
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
      }
      .modal-panel.show {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      .modal-mask {
        background: rgba(17,24,39,.2);
        backdrop-filter: blur(4px);
      }
      /* æ¡Œé¢ç«¯å¡ç‰‡æ‚¬åœæ•ˆæœ */
      .card {
        transition: all 0.2s ease;
      }
      .card:hover {
        box-shadow: 0 20px 35px -8px rgba(17,24,39,.1);
      }
    }

    /* å¹³æ¿å“åº”å¼è°ƒæ•´ */
    @media (min-width: 768px) and (max-width: 1023px) {
      .desktop-tip {
        display: block;
      }
      .mobile-shell {
        max-width: 720px;
      }
    }
  </style>
</head>
<body class="min-h-screen flex items-start justify-center p-3 md:p-4 lg:p-6">
  <div class="w-full max-w-7xl">
    <!-- Desktop tip (åªåœ¨å¹³æ¿æ˜¾ç¤º) -->
    <div class="desktop-tip mb-3 text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-xl px-3 py-2 md:block lg:hidden">
      å½“å‰ä¸ºå“åº”å¼å¸ƒå±€ Â· å·²é€‚é…æ¡Œé¢/å¹³æ¿/æ‰‹æœº
    </div>

    <!-- Header -->
    <header class="fade-up mb-3">
      <div class="card soft border border-gray-200 rounded-2xl p-3.5">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2.5">
            <div class="w-9 h-9 rounded-xl bg-black text-white grid place-items-center">
              <i class="fa-solid fa-wand-magic-sparkles text-sm"></i>
            </div>
            <div>
              <h1 class="text-base font-bold tracking-tight">AI æç¤ºè¯å·¥åŠ</h1>
              <p class="text-[11px] text-gray-500">ç”Ÿæˆ / ä¼˜åŒ– Â· æ™ºèƒ½åˆ¤æ–­ä»»åŠ¡ç±»å‹ Â· å“åº”å¼è®¾è®¡</p>
            </div>
          </div>
          <button id="openSettings" class="btn-press w-9 h-9 rounded-xl border border-gray-300 grid place-items-center hover:bg-gray-50">
            <i class="fa-solid fa-gear text-sm text-gray-700"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Security note -->
    <section class="mb-3 fade-up">
      <div class="border border-gray-200 rounded-xl px-3 py-2.5 bg-gray-50">
        <p class="text-[11px] text-gray-600 leading-5">
          å½“å‰ç‰ˆæœ¬ä¸ºå‰ç«¯ç›´è¿ APIï¼ˆæ— åç«¯ï¼‰ã€‚
          <span class="font-medium">API Key ä»…ä¿å­˜åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°ï¼ˆlocalStorageï¼‰</span>ï¼Œè¯·å‹¿åœ¨ä¸å¯ä¿¡è®¾å¤‡ä½¿ç”¨ã€‚
        </p>
      </div>
    </section>

    <!-- ä¸»å†…å®¹åŒºï¼šæ¡Œé¢åŒæ å¸ƒå±€ -->
    <div class="desktop-grid">
      <!-- Generate -->
      <section class="fade-up">
        <article class="card soft border border-gray-200 rounded-2xl p-3.5 h-full flex flex-col">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold">âœ¨ ç”Ÿæˆæç¤ºè¯</h2>
            <span class="text-[11px] text-gray-500">ä»æƒ³æ³•åˆ°é«˜è´¨é‡ Prompt</span>
          </div>

          <textarea id="generateInput" rows="6"
            class="mt-2.5 w-full rounded-xl border border-gray-300 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-black/10 focus:border-black resize-y flex-1"
            placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³åšä¸€ä¸ªçŸ­è§†é¢‘é€‰é¢˜ç ”ç©¶ï¼Œå¸®æˆ‘ç”Ÿæˆä¸€ä¸ªèƒ½æŒç»­äº§å‡ºé«˜è´¨é‡é€‰é¢˜çš„æç¤ºè¯"></textarea>

          <div class="mt-2.5 flex items-center gap-2 flex-wrap">
            <button id="generateBtn"
              class="btn-press inline-flex items-center gap-2 bg-black text-white text-sm rounded-xl px-4 py-2.5 disabled:opacity-60 disabled:cursor-not-allowed">
              <span class="btn-label">ç”Ÿæˆ</span>
            </button>
            <button id="clearGenerate" class="btn-press text-xs border border-gray-300 rounded-lg px-2.5 py-2 hover:bg-gray-50">
              æ¸…ç©º
            </button>
            <span id="generateStatus" class="text-[11px] text-gray-500"></span>
          </div>

          <div class="mt-3 flex-1">
            <div class="flex items-center justify-between mb-1.5">
              <span class="text-xs text-gray-500">ç»“æœ</span>
              <div class="flex items-center gap-1.5">
                <button id="copyGenerate" class="btn-press text-xs border border-gray-300 rounded-lg px-2.5 py-1.5 hover:bg-gray-50">
                  <i class="fa-regular fa-copy mr-1"></i>å¤åˆ¶
                </button>
                <button id="reuseGenerateToOptimize" class="btn-press text-xs border border-gray-300 rounded-lg px-2.5 py-1.5 hover:bg-gray-50">
                  é€å»ä¼˜åŒ–
                </button>
              </div>
            </div>
            <pre id="generateOutput"
              class="min-h-[140px] max-h-[320px] overflow-auto bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm leading-6 whitespace-pre-wrap"></pre>
          </div>
        </article>
      </section>

      <!-- Optimize -->
      <section class="fade-up">
        <article class="card soft border border-gray-200 rounded-2xl p-3.5 h-full flex flex-col">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold">ğŸ”„ ä¼˜åŒ–æç¤ºè¯</h2>
            <span class="text-[11px] text-gray-500">å¢å¼ºæ¸…æ™°åº¦ / çº¦æŸ / å¯æ‰§è¡Œæ€§</span>
          </div>

          <textarea id="optimizeInput" rows="6"
            class="mt-2.5 w-full rounded-xl border border-gray-300 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-black/10 focus:border-black resize-y flex-1"
            placeholder="ç²˜è´´ä½ å·²æœ‰çš„æç¤ºè¯ï¼ŒAI ä¼šè‡ªåŠ¨åˆ¤æ–­å¹¶ä¼˜åŒ–ï¼ˆä¸é™ç±»å‹ï¼‰"></textarea>

          <div class="mt-2.5 flex items-center gap-2 flex-wrap">
            <button id="optimizeBtn"
              class="btn-press inline-flex items-center gap-2 bg-black text-white text-sm rounded-xl px-4 py-2.5 disabled:opacity-60 disabled:cursor-not-allowed">
              <span class="btn-label">ä¼˜åŒ–</span>
            </button>
            <button id="clearOptimize" class="btn-press text-xs border border-gray-300 rounded-lg px-2.5 py-2 hover:bg-gray-50">
              æ¸…ç©º
            </button>
            <span id="optimizeStatus" class="text-[11px] text-gray-500"></span>
          </div>

          <div class="mt-3 flex-1">
            <div class="flex items-center justify-between mb-1.5">
              <span class="text-xs text-gray-500">ç»“æœ</span>
              <button id="copyOptimize" class="btn-press text-xs border border-gray-300 rounded-lg px-2.5 py-1.5 hover:bg-gray-50">
                <i class="fa-regular fa-copy mr-1"></i>å¤åˆ¶
              </button>
            </div>
            <pre id="optimizeOutput"
              class="min-h-[140px] max-h-[320px] overflow-auto bg-gray-50 border border-gray-200 rounded-xl p-3 text-sm leading-6 whitespace-pre-wrap"></pre>
          </div>
        </article>
      </section>

      <!-- Smart guide (æ¡Œé¢åŒæ åˆå¹¶) -->
      <section class="fade-up desktop-full mt-3 lg:mt-0">
        <article class="card soft border border-gray-200 rounded-2xl p-3.5">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <h3 class="text-sm font-semibold">ğŸ§  æ™ºèƒ½ç­–ç•¥ï¼ˆéå›ºå®šæ¨¡æ¿ï¼‰</h3>
            <button id="fillSmartHint" class="btn-press text-xs border border-gray-300 rounded-lg px-2.5 py-1.5 hover:bg-gray-50 self-start sm:self-auto">
              å¡«å…¥ç¤ºä¾‹éœ€æ±‚
            </button>
          </div>
          <ul class="mt-2 text-[12px] text-gray-600 leading-5 list-disc pl-4 grid grid-cols-1 sm:grid-cols-2 gap-x-4">
            <li>æ¨¡å‹ä¼šå…ˆç†è§£ä½ çš„æ„å›¾ï¼Œå†è‡ªåŠ¨åˆ¤æ–­ä»»åŠ¡ç±»å‹ï¼ˆå¯æ··åˆåœºæ™¯ï¼‰ã€‚</li>
            <li>è‡ªåŠ¨è¡¥è¶³ç»“æ„ï¼šè§’è‰²ã€ç›®æ ‡ã€ä¸Šä¸‹æ–‡ã€è¾“å…¥ã€çº¦æŸã€è¾“å‡ºæ ¼å¼ã€è´¨é‡æ ‡å‡†ã€è‡ªæ£€ã€‚</li>
            <li>ä½ åªéœ€å†™æ¸…æ¥šç›®æ ‡ä¸é™åˆ¶æ¡ä»¶ï¼Œä¸éœ€è¦å…ˆé€‰â€œå†™ä½œ/ç¼–ç¨‹/è®¾è®¡â€ç±»åˆ«ã€‚</li>
          </ul>
        </article>
      </section>

      <!-- History -->
      <section class="fade-up desktop-full mt-3">
        <article class="card soft border border-gray-200 rounded-2xl p-3.5">
          <div class="flex items-center justify-between">
            <h3 class="text-sm font-semibold">ğŸ“‹ æœ€è¿‘è®°å½•</h3>
            <button id="clearHistory" class="btn-press text-xs border border-gray-300 rounded-lg px-2 py-1.5 hover:bg-gray-50">
              æ¸…ç©º
            </button>
          </div>
          <div id="historyList" class="mt-2 space-y-2 max-h-[200px] overflow-y-auto pr-1"></div>
        </article>
      </section>
    </div>
  </div>

  <!-- Settings Modal (æ¡Œé¢ä¼˜åŒ–) -->
  <div id="mask" class="modal-mask"></div>
  <section id="panel" class="modal-panel bg-white border-t border-gray-200 soft safe-bottom">
    <div class="px-4 pt-3 pb-2 sticky top-0 bg-white border-b border-gray-100 z-10">
      <div class="mx-auto w-10 h-1.5 rounded-full bg-gray-300 mb-2 lg:hidden"></div>
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-semibold">âš™ï¸ æ¥å£è®¾ç½®</h3>
        <button id="closeSettings" class="btn-press w-8 h-8 rounded-lg border border-gray-300 grid place-items-center">
          <i class="fa-solid fa-xmark text-sm"></i>
        </button>
      </div>
      <p class="mt-1 text-[11px] text-gray-500">
        å…¼å®¹ OpenAI æ¥å£ã€‚Base URL è¯·è¾“å…¥åˆ° <span class="font-medium">/v1</span>ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‹¼æ¥ <span class="font-medium">/chat/completions</span>ã€‚
      </p>
    </div>

    <div class="px-4 py-3 space-y-3">
      <label class="block">
        <span class="text-xs text-gray-500">API Key</span>
        <input id="cfgApiKey" type="password" placeholder="sk-..."
          class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-black/10 focus:border-black" />
      </label>

      <label class="block">
        <span class="text-xs text-gray-500">Base URLï¼ˆåˆ° /v1ï¼‰</span>
        <input id="cfgBaseUrl" type="text" placeholder="https://api.openai.com/v1"
          class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-black/10 focus:border-black" />
      </label>

      <label class="block">
        <span class="text-xs text-gray-500">Model</span>
        <input id="cfgModel" type="text" placeholder="gpt-4o-mini"
          class="mt-1 w-full rounded-xl border border-gray-300 px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-black/10 focus:border-black" />
      </label>

      <label class="block">
        <div class="flex items-center justify-between">
          <span class="text-xs text-gray-500">Temperature</span>
          <span id="tempVal" class="text-xs text-gray-500">0.7</span>
        </div>
        <input id="cfgTemp" type="range" min="0" max="1" step="0.1" value="0.7" class="w-full mt-1" />
      </label>

      <div class="rounded-xl border border-gray-200 bg-gray-50 px-3 py-2 text-[11px] text-gray-600">
        å®é™…è¯·æ±‚åœ°å€ï¼š
        <div id="endpointPreview" class="mt-1 break-all text-gray-800 text-xs"></div>
      </div>

      <div class="flex flex-wrap items-center gap-2 pt-1">
        <button id="testConfig" class="btn-press inline-flex items-center gap-2 text-sm border border-gray-300 rounded-xl px-3 py-2.5 hover:bg-gray-50">
          <span class="btn-label">æµ‹è¯•è¿æ¥</span>
        </button>
        <button id="saveConfig" class="btn-press inline-flex items-center gap-2 text-sm bg-black text-white rounded-xl px-3 py-2.5">
          ä¿å­˜è®¾ç½®
        </button>
        <button id="resetConfig" class="btn-press text-sm border border-gray-300 rounded-xl px-3 py-2.5 hover:bg-gray-50">
          é»˜è®¤
        </button>
      </div>

      <p id="cfgStatus" class="text-xs text-gray-500"></p>
    </div>
  </section>

  <script>
    // -------------------------------
    // Storage keys
    // -------------------------------
    const LS = {
      apiKey: "pw_api_key",
      baseUrl: "pw_base_url",
      model: "pw_model",
      temp: "pw_temp",
      history: "pw_history"
    };

    // -------------------------------
    // Defaults
    // -------------------------------
    const DEFAULTS = {
      baseUrl: "https://api.openai.com/v1",
      model: "gpt-4o-mini",
      temp: 0.7
    };

    // -------------------------------
    // Elements
    // -------------------------------
    const el = {
      openSettings: document.getElementById("openSettings"),
      closeSettings: document.getElementById("closeSettings"),
      mask: document.getElementById("mask"),
      panel: document.getElementById("panel"),

      cfgApiKey: document.getElementById("cfgApiKey"),
      cfgBaseUrl: document.getElementById("cfgBaseUrl"),
      cfgModel: document.getElementById("cfgModel"),
      cfgTemp: document.getElementById("cfgTemp"),
      tempVal: document.getElementById("tempVal"),
      endpointPreview: document.getElementById("endpointPreview"),
      cfgStatus: document.getElementById("cfgStatus"),

      testConfig: document.getElementById("testConfig"),
      saveConfig: document.getElementById("saveConfig"),
      resetConfig: document.getElementById("resetConfig"),

      generateInput: document.getElementById("generateInput"),
      optimizeInput: document.getElementById("optimizeInput"),
      generateOutput: document.getElementById("generateOutput"),
      optimizeOutput: document.getElementById("optimizeOutput"),
      generateBtn: document.getElementById("generateBtn"),
      optimizeBtn: document.getElementById("optimizeBtn"),
      generateStatus: document.getElementById("generateStatus"),
      optimizeStatus: document.getElementById("optimizeStatus"),

      copyGenerate: document.getElementById("copyGenerate"),
      copyOptimize: document.getElementById("copyOptimize"),
      clearGenerate: document.getElementById("clearGenerate"),
      clearOptimize: document.getElementById("clearOptimize"),
      reuseGenerateToOptimize: document.getElementById("reuseGenerateToOptimize"),
      fillSmartHint: document.getElementById("fillSmartHint"),

      historyList: document.getElementById("historyList"),
      clearHistory: document.getElementById("clearHistory")
    };

    // -------------------------------
    // State
    // -------------------------------
    const state = {
      apiKey: "",
      baseUrl: DEFAULTS.baseUrl,
      model: DEFAULTS.model,
      temperature: DEFAULTS.temp
    };

    // -------------------------------
    // Utilities
    // -------------------------------
    function sanitizeBaseUrl(raw = "") {
      let u = (raw || "").trim();
      u = u.replace(/\/+$/, "");
      // å¦‚æœè¯¯å¡«äº† /chat/completionsï¼Œå»æ‰å®ƒ
      u = u.replace(/\/chat\/completions$/i, "");
      // å¦‚æœæ˜¯ /v1/chat/completions ä¹Ÿå»æ‰åˆ° /v1
      u = u.replace(/\/v1\/chat\/completions$/i, "/v1");
      return u;
    }

    function buildEndpoint(baseUrl) {
      let b = sanitizeBaseUrl(baseUrl);
      if (!b) return "";
      if (/\/chat\/completions$/i.test(b)) return b;
      return b + "/chat/completions";
    }

    function setStatus(node, msg, isErr = false) {
      node.textContent = msg || "";
      node.className = isErr ? "text-[11px] text-red-600" : "text-[11px] text-emerald-600";
    }

    function parseErrorMessage(raw) {
      const m = String(raw || "").toLowerCase();
      if (m.includes("401") || m.includes("unauthorized") || m.includes("invalid api key")) return "API Key æ— æ•ˆæˆ–å·²è¿‡æœŸ";
      if (m.includes("403")) return "æ— æƒé™è®¿é—®è¯¥æ¨¡å‹æˆ–æ¥å£";
      if (m.includes("404")) return "æ¥å£åœ°å€é”™è¯¯ï¼Œè¯·æ£€æŸ¥ Base URLï¼ˆåº”å¡«å†™åˆ° /v1ï¼‰";
      if (m.includes("429") || m.includes("rate")) return "è¯·æ±‚è¿‡å¤šæˆ–é¢åº¦ä¸è¶³ï¼Œè¯·ç¨åå†è¯•";
      if (m.includes("failed to fetch") || m.includes("network")) return "ç½‘ç»œé”™è¯¯æˆ–è·¨åŸŸæ‹¦æˆªï¼Œè¯·æ£€æŸ¥æ¥å£æœåŠ¡æ˜¯å¦å…è®¸æµè§ˆå™¨è°ƒç”¨";
      return raw || "è¯·æ±‚å¤±è´¥";
    }

    function setLoading(btn, isLoading, loadingText = "å¤„ç†ä¸­") {
      const label = btn.querySelector(".btn-label");
      if (isLoading) {
        btn.disabled = true;
        label.dataset.old = label.textContent;
        label.textContent = loadingText;
        const sp = document.createElement("span");
        sp.className = "spinner";
        sp.dataset.s = "1";
        btn.prepend(sp);
      } else {
        btn.disabled = false;
        btn.querySelector("[data-s='1']")?.remove();
        if (label.dataset.old) label.textContent = label.dataset.old;
      }
    }

    function copyText(text, statusNode) {
      if (!text?.trim()) return setStatus(statusNode, "æ²¡æœ‰å¯å¤åˆ¶å†…å®¹", true);
      navigator.clipboard.writeText(text).then(() => {
        setStatus(statusNode, "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
      }).catch(() => {
        setStatus(statusNode, "å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶", true);
      });
    }

    function getHistory() {
      try { return JSON.parse(localStorage.getItem(LS.history) || "[]"); }
      catch { return []; }
    }

    function saveHistoryItem(item) {
      const list = getHistory();
      list.unshift(item);
      const next = list.slice(0, 12);
      localStorage.setItem(LS.history, JSON.stringify(next));
      renderHistory();
    }

    function renderHistory() {
      const list = getHistory();
      if (!list.length) {
        el.historyList.innerHTML = `<p class="text-xs text-gray-500">æš‚æ— è®°å½•</p>`;
        return;
      }
      el.historyList.innerHTML = list.map((it, idx) => `
        <div class="border border-gray-200 rounded-xl p-2.5">
          <div class="flex items-center justify-between">
            <span class="text-[11px] font-medium">${it.mode === "generate" ? "ç”Ÿæˆ" : "ä¼˜åŒ–"} Â· ${new Date(it.time).toLocaleString()}</span>
            <button data-hcopy="${idx}" class="text-[11px] border border-gray-300 rounded-md px-2 py-1 hover:bg-gray-50">å¤åˆ¶ç»“æœ</button>
          </div>
          <p class="mt-1 text-[11px] text-gray-500 line-clamp-2">${escapeHtml(it.input)}</p>
        </div>
      `).join("");

      [...el.historyList.querySelectorAll("[data-hcopy]")].forEach(btn => {
        btn.onclick = () => {
          const i = Number(btn.dataset.hcopy);
          const item = getHistory()[i];
          navigator.clipboard.writeText(item?.output || "");
        };
      });
    }

    function escapeHtml(s="") {
      return s.replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // -------------------------------
    // Core API call
    // -------------------------------
    async function callChat({ mode, input }) {
      const endpoint = buildEndpoint(state.baseUrl);
      if (!state.apiKey) throw new Error("è¯·å…ˆåœ¨è®¾ç½®é‡Œå¡«å†™ API Key");
      if (!state.baseUrl) throw new Error("è¯·å…ˆåœ¨è®¾ç½®é‡Œå¡«å†™ Base URL");
      if (!state.model) throw new Error("è¯·å…ˆåœ¨è®¾ç½®é‡Œå¡«å†™æ¨¡å‹åç§°");

      const systemGenerate = `
ä½ æ˜¯é¡¶çº§æç¤ºè¯æ¶æ„å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼šæ ¹æ®ç”¨æˆ·ç»™å‡ºçš„â€œç²—ç•¥éœ€æ±‚â€ï¼Œè‡ªåŠ¨åˆ¤æ–­ä»»åŠ¡æ€§è´¨ä¸ç›®æ ‡ï¼Œç”Ÿæˆä¸€ä¸ªå¯ç›´æ¥ä½¿ç”¨çš„é«˜è´¨é‡æç¤ºè¯ã€‚

è¦æ±‚ï¼š
1) ä¸è¦æŠŠä»»åŠ¡ç¡¬åˆ†ç±»ï¼Œä¸è¦è¦æ±‚ç”¨æˆ·å…ˆé€‰ç±»å‹ï¼›ä½ è‡ªè¡Œåˆ¤æ–­ã€‚
2) è¾“å‡ºä»…ä¸ºâ€œæœ€ç»ˆæç¤ºè¯æ­£æ–‡â€ï¼Œä¸è¦è§£é‡Šã€ä¸è¦å‰åç¼€ã€‚
3) è‡ªåŠ¨è¡¥é½é«˜è´¨é‡ç»“æ„ï¼šè§’è‰²ã€ç›®æ ‡ã€ä¸Šä¸‹æ–‡ã€è¾“å…¥ã€çº¦æŸã€è¾“å‡ºæ ¼å¼ã€è´¨é‡æ ‡å‡†ã€è‡ªæ£€æ¸…å•ã€‚
4) å¦‚æœç”¨æˆ·ä¿¡æ¯ä¸è¶³ï¼Œç”¨å¯æ›¿æ¢å ä½ç¬¦ [å¾…è¡¥å……:xxx] åšæœ€å°å¿…è¦è¡¥å…¨ã€‚
5) è¯­è¨€æ¸…æ™°ã€å¯æ‰§è¡Œã€æ— æ­§ä¹‰ï¼Œé»˜è®¤ä¸­æ–‡ï¼Œå¯åœ¨æç¤ºè¯ä¸­å…è®¸ç”¨æˆ·æŒ‡å®šè¯­è¨€ã€‚
6) äº§ç‰©è¦å…¼å®¹å¤šæ•° AI æ¨¡å‹ï¼ˆé€šç”¨ã€ç¨³å¥ï¼‰ã€‚
      `.trim();

      const systemOptimize = `
ä½ æ˜¯æç¤ºè¯é‡æ„ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼šåœ¨ä¸æ”¹å˜ç”¨æˆ·æ ¸å¿ƒæ„å›¾çš„å‰æä¸‹ï¼Œä¼˜åŒ–å…¶æç¤ºè¯è´¨é‡ã€‚

è¦æ±‚ï¼š
1) ä¸è¦å›ºå®šæˆæŸä¸€é¢†åŸŸæ¨¡æ¿ï¼›è¯·å…ˆç†è§£æ„å›¾åè‡ªé€‚åº”é‡å†™ã€‚
2) è¾“å‡ºä»…ä¸ºâ€œä¼˜åŒ–åçš„æç¤ºè¯æ­£æ–‡â€ï¼Œä¸è¦è§£é‡Šã€ä¸è¦å¯¹æ¯”è¯´æ˜ã€‚
3) å¼ºåŒ–ï¼šå…·ä½“æ€§ã€ä¸Šä¸‹æ–‡å®Œæ•´åº¦ã€çº¦æŸæ¸…æ™°åº¦ã€è¾“å‡ºæ ¼å¼å¯éªŒè¯æ€§ã€‚
4) ä¿ç•™åŸæç¤ºè¯ä¸­æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼Œåˆ æ‰æ­§ä¹‰å’Œå†—ä½™ã€‚
5) å¿…è¦æ—¶è¡¥å……å¯æ›¿æ¢å ä½ç¬¦ [å¾…è¡¥å……:xxx]ï¼Œé¿å…ç©ºæ³›ã€‚
6) é»˜è®¤ä¸­æ–‡è¡¨è¾¾ï¼Œé€»è¾‘ç´§å‡‘ã€‚
      `.trim();

      const payload = {
        model: state.model,
        temperature: Number(state.temperature),
        messages: [
          { role: "system", content: mode === "generate" ? systemGenerate : systemOptimize },
          { role: "user", content: input }
        ]
      };

      const res = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${state.apiKey}`
        },
        body: JSON.stringify(payload)
      });

      let data = null;
      try { data = await res.json(); } catch { data = null; }

      if (!res.ok) {
        const errMsg = data?.error?.message || data?.message || `HTTP ${res.status}`;
        throw new Error(errMsg);
      }

      const text = data?.choices?.[0]?.message?.content ?? "";
      if (!text) throw new Error("æ¥å£è¿”å›ä¸ºç©º");
      return text.trim();
    }

    // -------------------------------
    // Actions
    // -------------------------------
    async function runMode(mode) {
      const isGen = mode === "generate";
      const input = isGen ? el.generateInput.value.trim() : el.optimizeInput.value.trim();
      const btn = isGen ? el.generateBtn : el.optimizeBtn;
      const out = isGen ? el.generateOutput : el.optimizeOutput;
      const status = isGen ? el.generateStatus : el.optimizeStatus;

      if (!input) return setStatus(status, isGen ? "è¯·å…ˆè¾“å…¥éœ€æ±‚" : "è¯·å…ˆè¾“å…¥æç¤ºè¯", true);

      out.textContent = "";
      setLoading(btn, true, isGen ? "ç”Ÿæˆä¸­" : "ä¼˜åŒ–ä¸­");
      setStatus(status, "è¯·æ±‚ä¸­...");

      try {
        const t0 = performance.now();
        const text = await callChat({ mode, input });
        const ms = Math.round(performance.now() - t0);
        out.textContent = text;
        setStatus(status, `å®Œæˆ Â· ${ms}ms`);
        saveHistoryItem({ mode, input, output: text, time: Date.now() });
      } catch (e) {
        setStatus(status, parseErrorMessage(e.message), true);
      } finally {
        setLoading(btn, false);
      }
    }

    // -------------------------------
    // Settings modal
    // -------------------------------
    function openSettings() {
      el.mask.classList.add("show");
      el.panel.classList.add("show");
    }
    function closeSettings() {
      el.mask.classList.remove("show");
      el.panel.classList.remove("show");
    }

    function syncPreview() {
      el.tempVal.textContent = String(el.cfgTemp.value);
      const endpoint = buildEndpoint(el.cfgBaseUrl.value);
      el.endpointPreview.textContent = endpoint || "ï¼ˆè¯·å¡«å†™ Base URLï¼‰";
    }

    async function testConfig() {
      const apiKey = el.cfgApiKey.value.trim();
      const baseUrl = sanitizeBaseUrl(el.cfgBaseUrl.value);
      const model = el.cfgModel.value.trim();
      const temperature = Number(el.cfgTemp.value);
      const endpoint = buildEndpoint(baseUrl);

      if (!apiKey || !baseUrl || !model) {
        return setStatus(el.cfgStatus, "è¯·å…ˆå¡«å†™å®Œæ•´é…ç½®", true);
      }

      setLoading(el.testConfig, true, "æµ‹è¯•ä¸­");
      setStatus(el.cfgStatus, "æ­£åœ¨æµ‹è¯•è¿æ¥...");

      try {
        const t0 = performance.now();
        const res = await fetch(endpoint, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model,
            temperature,
            messages: [
              { role: "system", content: "ä½ æ˜¯è¿æ¥æµ‹è¯•åŠ©æ‰‹ã€‚è¯·ä»…å›å¤ï¼šOK" },
              { role: "user", content: "ping" }
            ],
            max_tokens: 8
          })
        });

        let data = null;
        try { data = await res.json(); } catch { data = null; }

        if (!res.ok) {
          const em = data?.error?.message || `HTTP ${res.status}`;
          throw new Error(em);
        }

        const used = data?.model || model;
        const ms = Math.round(performance.now() - t0);
        setStatus(el.cfgStatus, `æµ‹è¯•æˆåŠŸ âœ… æ¨¡å‹: ${used} Â· ${ms}ms`);
      } catch (e) {
        setStatus(el.cfgStatus, parseErrorMessage(e.message), true);
      } finally {
        setLoading(el.testConfig, false);
      }
    }

    function saveConfig() {
      const apiKey = el.cfgApiKey.value.trim();
      const baseUrl = sanitizeBaseUrl(el.cfgBaseUrl.value);
      const model = el.cfgModel.value.trim();
      const temp = Number(el.cfgTemp.value);

      if (!apiKey || !baseUrl || !model) {
        return setStatus(el.cfgStatus, "è¯·å…ˆå¡«å†™å®Œæ•´é…ç½®", true);
      }

      localStorage.setItem(LS.apiKey, apiKey);
      localStorage.setItem(LS.baseUrl, baseUrl);
      localStorage.setItem(LS.model, model);
      localStorage.setItem(LS.temp, String(temp));

      state.apiKey = apiKey;
      state.baseUrl = baseUrl;
      state.model = model;
      state.temperature = temp;

      setStatus(el.cfgStatus, "è®¾ç½®å·²ä¿å­˜");
      setTimeout(closeSettings, 260);
    }

    function resetConfig() {
      el.cfgApiKey.value = "";
      el.cfgBaseUrl.value = DEFAULTS.baseUrl;
      el.cfgModel.value = DEFAULTS.model;
      el.cfgTemp.value = String(DEFAULTS.temp);
      syncPreview();
      setStatus(el.cfgStatus, "å·²æ¢å¤é»˜è®¤ï¼ˆæœªä¿å­˜ï¼‰");
    }

    function loadConfig() {
      state.apiKey = localStorage.getItem(LS.apiKey) || "";
      state.baseUrl = localStorage.getItem(LS.baseUrl) || DEFAULTS.baseUrl;
      state.model = localStorage.getItem(LS.model) || DEFAULTS.model;
      state.temperature = Number(localStorage.getItem(LS.temp) || DEFAULTS.temp);

      el.cfgApiKey.value = state.apiKey;
      el.cfgBaseUrl.value = state.baseUrl;
      el.cfgModel.value = state.model;
      el.cfgTemp.value = String(state.temperature);
      syncPreview();
    }

    // -------------------------------
    // Event bindings
    // -------------------------------
    el.openSettings.onclick = openSettings;
    el.closeSettings.onclick = closeSettings;
    el.mask.onclick = closeSettings;

    el.cfgBaseUrl.addEventListener("input", syncPreview);
    el.cfgTemp.addEventListener("input", syncPreview);

    el.testConfig.onclick = testConfig;
    el.saveConfig.onclick = saveConfig;
    el.resetConfig.onclick = resetConfig;

    el.generateBtn.onclick = () => runMode("generate");
    el.optimizeBtn.onclick = () => runMode("optimize");

    el.copyGenerate.onclick = () => copyText(el.generateOutput.textContent, el.generateStatus);
    el.copyOptimize.onclick = () => copyText(el.optimizeOutput.textContent, el.optimizeStatus);

    el.clearGenerate.onclick = () => { el.generateInput.value = ""; el.generateOutput.textContent = ""; setStatus(el.generateStatus, ""); };
    el.clearOptimize.onclick = () => { el.optimizeInput.value = ""; el.optimizeOutput.textContent = ""; setStatus(el.optimizeStatus, ""); };

    el.reuseGenerateToOptimize.onclick = () => {
      if (!el.generateOutput.textContent.trim()) return setStatus(el.generateStatus, "å…ˆç”Ÿæˆå†…å®¹å†ä½¿ç”¨æ­¤åŠŸèƒ½", true);
      el.optimizeInput.value = el.generateOutput.textContent.trim();
      window.scrollTo({ top: document.body.scrollHeight / 2, behavior: "smooth" });
      setStatus(el.generateStatus, "å·²å¡«å…¥ä¼˜åŒ–åŒº");
    };

    el.fillSmartHint.onclick = () => {
      el.generateInput.value = `æˆ‘æƒ³åšä¸€ä¸ªâ€œæ¯å‘¨è¾“å‡ºè¡Œä¸šæ´å¯Ÿâ€çš„å·¥ä½œæµï¼Œè¯·å¸®æˆ‘å†™ä¸€ä¸ªé€šç”¨æç¤ºè¯ï¼š
- æˆ‘ä¼šæä¾›ï¼šè¡Œä¸šä¸»é¢˜ã€ç›®æ ‡è¯»è€…ã€å¯ç”¨æ•°æ®æ¥æº
- æˆ‘å¸Œæœ›è¾“å‡ºï¼šè§‚ç‚¹æ‘˜è¦ã€å…³é”®è¯æ®ã€å¯æ‰§è¡Œå»ºè®®ã€é£é™©æç¤º
- ç»“æœé£æ ¼ï¼šä¸“ä¸šä½†æ˜“è¯»ï¼Œé€‚åˆå…¬ä¼—å·å’Œå†…éƒ¨æ±‡æŠ¥
- çº¦æŸï¼šè¦æœ‰ç»“æ„åŒ–æ ¼å¼ï¼Œå¯é‡å¤ä½¿ç”¨`;
      setStatus(el.generateStatus, "å·²å¡«å…¥ç¤ºä¾‹éœ€æ±‚");
    };

    el.clearHistory.onclick = () => {
      localStorage.removeItem(LS.history);
      renderHistory();
    };

    // Enter to submit (with modifier keys)
    [el.generateInput, el.optimizeInput].forEach((ta, idx) => {
      ta.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
          e.preventDefault();
          idx === 0 ? runMode("generate") : runMode("optimize");
        }
      });
    });

    // ç‚¹å‡»æ¨¡æ€é¢æ¿å†…éƒ¨ä¸å…³é—­
    el.panel.addEventListener("click", (e) => e.stopPropagation());

    // -------------------------------
    // Init animation + boot
    // -------------------------------
    const io = new IntersectionObserver((entries) => {
      entries.forEach(ent => ent.isIntersecting && ent.target.classList.add("in"));
    }, { threshold: .1 });
    document.querySelectorAll(".fade-up").forEach(n => io.observe(n));

    loadConfig();
    renderHistory();

    // é¦–æ¬¡æ— é…ç½®è‡ªåŠ¨å¼¹è®¾ç½®
    if (!state.apiKey) {
      setTimeout(openSettings, 250);
    }
  </script>
</body>
</html>